
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travelverse Itinerary Planner</title>

    <!-- External libraries for PDF generation - Internet Connection Required -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- External library for Drag-and-Drop - Internet Connection Required -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>


    <style>
        /* --- Google Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        /* --- MODERN UI - APPLE INSPIRED --- */
        :root {
            --brand-blue: #05C3DE; /* Updated Brand Color */
            --brand-blue-light: #4ee0f0; /* Lighter version of new brand color */
            --bg-color: #f5f5f7;
            --card-bg-color: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --border-color: #d2d2d7;
            --error-color: #bf0a28;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius-l: 18px;
            --radius-m: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container { max-width: 960px; margin: 40px auto; padding: 20px; }

        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(45deg, #333, var(--brand-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--radius-l);
            box-shadow: var(--shadow);
            padding: 35px 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .full-width {
            grid-column: 1 / -1;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            font-size: 1rem;
            transition: all 0.2s ease;
            background-color: #fafafa;
        }

        input:disabled {
            background-color: #f0f0f2;
            cursor: not-allowed;
            color: #999;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 4px rgba(5, 195, 222, 0.15); /* Updated focus color */
            background-color: #fff;
        }

        button {
            border: none;
            border-radius: var(--radius-m);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--brand-blue);
            color: white;
            padding: 18px 28px;
            width: 100%;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(5, 195, 222, 0.2); /* Updated shadow color */
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--brand-blue-light);
            box-shadow: 0 6px 15px rgba(5, 195, 222, 0.3); /* Updated shadow color */
        }

        .btn-secondary {
            background-color: #e8e8ed;
            color: var(--text-primary);
            padding: 16px 24px;
        }
        .btn-secondary:hover { background-color: #dcdce1; }
        
        .btn-dark {
            background-color: #333;
            color: white;
        }
        .btn-dark:hover {
            background-color: #555;
        }

        .btn-remove {
            background-color: #ffe5e9;
            color: var(--error-color);
            padding: 8px 14px;
            font-size: 0.8rem;
        }
        .btn-remove:hover { background-color: var(--error-color); color: white; }
        
        .btn-edit {
            background-color: #e6f7ff;
            color: #00609a;
            padding: 8px 14px;
            font-size: 0.8rem;
        }
        .btn-edit:hover { background-color: #ccefff; }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            font-weight: 500;
            color: var(--text-primary);
            flex-grow: 1;
        }
        
        .custom-add-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 25px 0;
        }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #f0f0f2;}
        thead th {
            background-color: var(--card-bg-color);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-top: 1px solid #f0f0f2;
        }
        tbody tr:last-child td { border-bottom: none; }
        td.actions-cell {
            display: flex;
            gap: 8px;
        }

        /* Style for draggable rows */
        tbody tr {
            cursor: grab;
        }
        .sortable-ghost {
            background: #e6f7ff;
            opacity: 0.7;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        
        #itinerary { animation: fadeIn 0.8s ease-in-out; }
        .itinerary-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: var(--radius-l);
            margin-bottom: 30px;
        }
        .summary-item { display: flex; align-items: center; gap: 12px; }
        .summary-item .icon { font-size: 1.5rem; color: var(--brand-blue); }
        .summary-item div { font-size: 0.9rem; }
        .summary-item strong { color: var(--text-primary); font-weight: 600; display: block; }
        .summary-item span { color: var(--text-secondary); }

        .total {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: right;
            margin-top: 20px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
        }
        .total span { color: var(--text-secondary); font-weight: 500; }

        .hidden { display: none; }

        #error-display {
            background-color: #fff0f2; color: var(--error-color);
            padding: 15px; border-radius: var(--radius-m);
            border-left: 5px solid var(--error-color);
            margin-bottom: 20px; text-align: center; font-weight: 600;
            animation: fadeIn 0.3s ease-out;
        }
        
        .day-timeline {
            position: relative;
            padding: 20px 0;
            margin-top: 40px; 
        }
        .day-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px; 
            height: calc(100% - 80px); 
            width: 2px;
            background: #e8e8ed;
        }
        .day-entry {
            position: relative;
            margin-left: 60px;
            margin-bottom: 30px;
            background: var(--bg-color);
            border-radius: var(--radius-l);
            padding: 20px;
        }
        .day-entry:first-child::before {
            top: 18px; 
        }

        .day-entry::before {
            content: attr(data-day);
            position: absolute;
            left: -58px; top: 18px;
            width: 36px; height: 36px;
            background: var(--brand-blue);
            color: white;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-weight: 700;
            border: 4px solid var(--card-bg-color);
        }
        .day-entry h4 { margin: 0 0 15px 0; font-weight: 700; }
        .day-item-list { list-style-type: none; padding-left: 0; }
        .day-item-list li {
            display: flex; gap: 15px;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e3;
        }
        .day-item-list li:last-child { border-bottom: none; }
        .day-item-list .icon { font-size: 1.2rem; color: var(--brand-blue); line-height: 1.6; }
        .day-item-list .item-details { display: flex; flex-direction: column; }
        .day-item-list .item-title { font-weight: 600; }
        .day-item-list .item-location { font-size: 0.9rem; color: var(--text-secondary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Travelverse Itinerary Planner</h1>
        </header>

        <div id="error-display" class="hidden"></div>
        
        <!-- FORM SECTIONS -->
        <div class="card">
            <h2>👤 Traveler Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="clientName">Full Name</label>
                    <input type="text" id="clientName" placeholder="e.g., Jane Doe">
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" placeholder="your@email.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="country">Country</label>
                    <input type="text" id="country" placeholder="e.g., Italy">
                </div>
            </div>
            <p><strong>Number of Nights:</strong> <span id="nightsDisplay">0</span></p>
            <div class="form-group" style="margin-top: 20px;">
                <label for="place">Places to Travel</label>
                <div class="place-form" style="display:flex; gap:10px;">
                    <input type="text" id="place" placeholder="e.g., Rome">
                    <button id="addPlaceBtn" class="btn-secondary" onclick="addPlace()">Add Place</button>
                </div>
                <div id="placesList" style="margin-top:15px;"></div>
            </div>
            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="adults">Adults</label>
                    <input type="number" id="adults" placeholder="1" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="kids">Kids</label>
                    <input type="number" id="kids" placeholder="0" min="0" value="0" oninput="updateKidsAges()">
                </div>
            </div>
            <div id="kidsAgesContainer" class="form-row"></div>
        </div>

        <div class="card">
            <h2>✈️ Flight Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="airline">Airline</label>
                    <input type="text" id="airline" placeholder="Enter airline name">
                </div>
                <div class="form-group">
                    <label for="departure">Departure City</label>
                    <input type="text" id="departure" placeholder="e.g., New York">
                </div>
                <div class="form-group">
                    <label for="arrival">Arrival City</label>
                    <input type="text" id="arrival" placeholder="e.g., Rome">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="flightDate">Flight Date</label>
                    <input type="date" id="flightDate">
                </div>
                <div class="form-group">
                    <label for="flightCost">Cost (₹)</label>
                    <input type="number" id="flightCost" placeholder="0.00" min="0">
                </div>
                <div class="form-group">
                    <label for="flightDescription">Description</label>
                    <input type="text" id="flightDescription" placeholder="e.g., 1 stop, 25 Kgs Baggage">
                </div>
            </div>
            <div id="flightActions" class="action-buttons">
                <button class="btn-secondary" onclick="addFlight()">+ Add Flight</button>
            </div>
        </div>
        
        <div class="card">
            <h2>🚆 Train Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="trainName">Train Name/Operator</label>
                    <input type="text" id="trainName" placeholder="e.g., Eurostar">
                </div>
                <div class="form-group">
                    <label for="trainDate">Date</label>
                    <input type="date" id="trainDate">
                </div>
                <div class="form-group">
                    <label for="trainTime">Time</label>
                    <input type="time" id="trainTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="trainDescription">Description</label>
                    <input type="text" id="trainDescription" placeholder="e.g., Paris to London, First Class">
                </div>
                 <div class="form-group">
                    <label for="trainCost">Cost (₹)</label>
                    <input type="number" id="trainCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="trainActions" class="action-buttons">
                <button class="btn-secondary" onclick="addTrain()">+ Add Train</button>
            </div>
        </div>

        <div class="card">
            <h2>🚌 Bus Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="busName">Bus Name/Operator</label>
                    <input type="text" id="busName" placeholder="e.g., FlixBus">
                </div>
                <div class="form-group">
                    <label for="busDate">Date</label>
                    <input type="date" id="busDate">
                </div>
                 <div class="form-group">
                    <label for="busCost">Cost (₹)</label>
                    <input type="number" id="busCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="busDescription">Description</label>
                    <input type="text" id="busDescription" placeholder="e.g., Rome to Florence, scenic route">
                </div>
            </div>
            <div id="busActions" class="action-buttons">
                <button class="btn-secondary" onclick="addBus()">+ Add Bus</button>
            </div>
        </div>
        
        <div class="card">
            <h2>🚗 Airport/Train Station Transfers</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="transferName">Transfer Name</label>
                    <input type="text" id="transferName" placeholder="e.g., Airport Pickup">
                </div>
                <div class="form-group">
                    <label for="transferType">Transfer Type</label>
                    <select id="transferType">
                        <option value="Private Car">Private Car</option>
                        <option value="Shuttle Bus">Shuttle Bus</option>
                        <option value="Train">Train</option>
                        <option value="Taxi">Taxi</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferCost">Cost (₹)</label>
                    <input type="number" id="transferCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="transferActions" class="action-buttons">
                <button class="btn-secondary" onclick="addTransfer()">+ Add Transfer</button>
            </div>
        </div>

        <div class="card">
            <h2>🏨 Hotel Accommodations</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="hotelName">Hotel Name</label>
                    <input type="text" id="hotelName" placeholder="e.g., Colosseum Hotel">
                </div>
                <div class="form-group">
                    <label for="hotelLocation">Location</label>
                    <input type="text" id="hotelLocation" placeholder="e.g., Rome">
                </div>
                <div class="form-group">
                    <label for="roomCategory">Room Category</label>
                    <input type="text" id="roomCategory" placeholder="e.g., Deluxe Room">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="checkIn">Check-In Date</label>
                    <input type="date" id="checkIn">
                </div>
                <div class="form-group">
                    <label for="checkOut">Check-Out Date</label>
                    <input type="date" id="checkOut" disabled>
                </div>
                <div class="form-group">
                    <label for="hotelCost">Total Cost (₹)</label>
                    <input type="number" id="hotelCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="hotelActions" class="action-buttons">
                <button class="btn-secondary" onclick="addHotel()">+ Add Hotel</button>
            </div>
        </div>

        <div class="card">
            <h2>🏞️ Activities & Tours</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="activityName">Activity Name</label>
                    <input type="text" id="activityName" placeholder="e.g., Colosseum Tour">
                </div>
                <div class="form-group">
                    <label for="activityLocation">Location</label>
                    <input type="text" id="activityLocation" placeholder="e.g., Rome">
                </div>
                <div class="form-group">
                    <label for="activityDate">Date</label>
                    <input type="date" id="activityDate">
                </div>
                 <div class="form-group">
                    <label for="activityCost">Cost (₹)</label>
                    <input type="number" id="activityCost" placeholder="0.00" min="0">
                </div>
            </div>
             <div class="form-row">
                <div class="form-group full-width">
                    <label for="activityDescription">Description</label>
                    <input type="text" id="activityDescription" placeholder="e.g., Private tour with guide">
                </div>
            </div>
            <div id="activityActions" class="action-buttons">
                <button class="btn-secondary" onclick="addActivity()">+ Add Activity</button>
            </div>
        </div>
        
        <div class="card">
            <h2>💰 Costing & Margin</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="marginCost">Margin (₹)</label>
                    <input type="number" id="marginCost" placeholder="e.g., 10000.00" min="0">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>📦 Inclusions & Exclusions</h2>
            <div class="form-row" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3>Inclusions</h3>
                    <div id="inclusionsList"></div>
                    <div class="custom-add-form">
                        <input type="text" id="customInclusion" placeholder="Add custom inclusion">
                        <button class="btn-secondary" onclick="addInclusionExclusion('inclusion')">Add</button>
                    </div>
                </div>
                <div>
                    <h3>Exclusions</h3>
                    <div id="exclusionsList"></div>
                    <div class="custom-add-form">
                        <input type="text" id="customExclusion" placeholder="Add custom exclusion">
                        <button class="btn-secondary" onclick="addInclusionExclusion('exclusion')">Add</button>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="btn-primary" onclick="generateItinerary(true)">Generate Travel Plan</button>

        <!-- ITINERARY OUTPUT SECTION -->
        <div id="itinerary" class="hidden">
            <div class="card">
                <h2>Trip Summary</h2>
                <div class="itinerary-summary">
                    <div class="summary-item"><span class="icon">👤</span><div><strong>Name</strong><span id="itineraryClientName"></span></div></div>
                    <div class="summary-item"><span class="icon">📧</span><div><strong>Email</strong><span id="itineraryClientEmail"></span></div></div>
                    <div class="summary-item"><span class="icon">📅</span><div><strong>Travel Dates</strong><span id="itineraryTravelDates"></span></div></div>
                    <div class="summary-item"><span class="icon">🌍</span><div><strong>Country</strong><span id="itineraryCountry"></span></div></div>
                    <div class="summary-item"><span class="icon">📍</span><div><strong>Places</strong><span id="itineraryPlaces"></span></div></div>
                    <div class="summary-item"><span class="icon">🌙</span><div><strong>Nights</strong><span id="itineraryNights"></span></div></div>
                    <div class="summary-item"><span class="icon">👥</span><div><strong>Travelers</strong><span id="itineraryTravelers"></span></div></div>
                </div>
                
                <div id="flights_section">
                    <h2>Flights</h2>
                    <table id="flightsTable">
                        <thead>
                            <tr><th>Airline</th><th>From</th><th>To</th><th>Date</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="trains_section">
                    <h2>Trains</h2>
                    <table id="trainsTable">
                        <thead>
                            <tr><th>Operator</th><th>Date</th><th>Time</th><th>Description</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="buses_section">
                    <h2>Buses</h2>
                    <table id="busesTable">
                        <thead>
                            <tr><th>Operator</th><th>Date</th><th>Description</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                 <div id="transfers_section">
                    <h2>Transfers</h2>
                    <table id="transfersTable">
                        <thead>
                            <tr><th>Name</th><th>Type</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="hotels_section">
                    <h2>Hotels</h2>
                    <table id="hotelsTable">
                        <thead>
                            <tr><th>Name</th><th>Location</th><th>Room Category</th><th>Check-In</th><th>Check-Out</th><th>Total Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="activities_section">
                    <h2>Activities</h2>
                    <table id="activitiesTable">
                        <thead>
                            <tr><th>Activity</th><th>Description</th><th>Date</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="daywise_section">
                    <h2>Day-wise Itinerary</h2>
                    <div id="dayWiseItinerary" class="day-timeline"></div>
                </div>
                
                <div id="inc_exc_section_html" class="hidden">
                     <div class="form-row" style="grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px;">
                        <div>
                            <h3 style="font-size: 1.3rem;">Inclusions</h3>
                            <ul id="inclusionsListHtml" style="list-style-position: inside; padding-left: 10px; color: var(--text-secondary);"></ul>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem;">Exclusions</h3>
                            <ul id="exclusionsListHtml" style="list-style-position: inside; padding-left: 10px; color: var(--text-secondary);"></ul>
                        </div>
                    </div>
                </div>

                <div class="total">
                    <span>Total Estimated Cost: </span>₹<span id="totalCost">0.00</span>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
                    <button class="btn-primary" onclick="downloadPDF('client')" style="flex-grow: 1;">📄 Download Client Quote</button>
                    <button class="btn-dark" onclick="downloadPDF('business')" style="flex-grow: 1;">📈 Download Business Copy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE AND ALL UI LOGIC ---
        let flights = [], trains = [], buses = [], hotels = [], activities = [], places = [], inclusions = [], exclusions = [], transfers = [];
        let currentlyEditing = null; // { type: 'flight', index: 0 }
        const errorDisplay = document.getElementById("error-display");
        
        const predefinedInclusions = [ 'International Flight', 'Internal Flight', 'Private Airport Transfers', 'Accommodation with breakfast', 'Mentioned Sightseeings, transfers', 'Inter hotel Transfers', 'Visa', 'GST' ];
        const predefinedExclusions = [ 'TCS', 'Flights', 'Beverages, Lunch, Dinner throughout the tours', 'City tax at the Hotel if applicable', 'Any other services not specified above', 'Any Personal Expenses', 'Early check in/Late check out' ];

        function displayError(message) { errorDisplay.textContent = message; errorDisplay.classList.remove('hidden'); }
        function clearError() { if (!errorDisplay.classList.contains('hidden')) { errorDisplay.classList.add('hidden'); } }
        function calculateNights(start, end) { if (!start || !end) return 0; const startDate = new Date(start); const endDate = new Date(end); return (endDate > startDate) ? Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) : 0; }

        function saveData() {
            const data = {
                clientName: document.getElementById("clientName").value, clientEmail: document.getElementById("clientEmail").value,
                startDate: document.getElementById("startDate").value, endDate: document.getElementById("endDate").value,
                country: document.getElementById("country").value, adults: document.getElementById("adults").value,
                kids: document.getElementById("kids").value, places,
                marginCost: document.getElementById("marginCost").value,
                flights, trains, buses, transfers, hotels, activities, inclusions, exclusions
            };
            localStorage.setItem('travelItineraryData', JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem('travelItineraryData');
            const data = savedData ? JSON.parse(savedData) : {};
            
            document.getElementById("clientName").value = data.clientName || '';
            document.getElementById("clientEmail").value = data.clientEmail || '';
            document.getElementById("startDate").value = data.startDate || '';
            document.getElementById("endDate").value = data.endDate || '';
            document.getElementById("country").value = data.country || '';
            document.getElementById("adults").value = data.adults || '1';
            document.getElementById("kids").value = data.kids || '0';
            document.getElementById("marginCost").value = data.marginCost || '';
            places = data.places || [];
            flights = data.flights || [];
            trains = data.trains || [];
            buses = data.buses || [];
            transfers = data.transfers || [];
            hotels = data.hotels || [];
            activities = data.activities || [];
            inclusions = data.inclusions || predefinedInclusions.map(text => ({ text, checked: true, custom: false }));
            exclusions = data.exclusions || predefinedExclusions.map(text => ({ text, checked: true, custom: false }));

            renderInclusionsExclusions();
            initializeDateLogic(); 
            updateKidsAges();
            renderPlaces();

            if (data.clientName) { generateItinerary(); }
        }
        
        function renderInclusionsExclusions() {
            const renderList = (type, listContainerId) => {
                const list = type === 'inclusion' ? inclusions : exclusions;
                const container = document.getElementById(listContainerId);
                container.innerHTML = '';
                list.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-group';
                    const checkboxId = `${type}-${index}`;
                    div.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" onchange="toggleInclusionExclusion('${type}', ${index})" ${item.checked ? 'checked' : ''}>
                        <label for="${checkboxId}">${item.text}</label>
                        ${item.custom ? `<button class="btn-remove" style="padding: 2px 8px; font-size: 12px;" onclick="removeInclusionExclusion('${type}', ${index})">✖</button>` : ''}
                    `;
                    container.appendChild(div);
                });
            };
            renderList('inclusion', 'inclusionsList');
            renderList('exclusion', 'exclusionsList');
            saveData();
        }

        function toggleInclusionExclusion(type, index) { const list = type === 'inclusion' ? inclusions : exclusions; list[index].checked = !list[index].checked; saveData(); if(!document.getElementById('itinerary').classList.contains('hidden')) { generateItinerary(); } }
        function addInclusionExclusion(type) { const inputId = type === 'inclusion' ? 'customInclusion' : 'customExclusion'; const input = document.getElementById(inputId); const text = input.value.trim(); if (text) { const list = type === 'inclusion' ? inclusions : exclusions; list.push({ text, checked: true, custom: true }); input.value = ''; renderInclusionsExclusions(); } }
        function removeInclusionExclusion(type, index) { const list = type === 'inclusion' ? inclusions : exclusions; list.splice(index, 1); renderInclusionsExclusions(); }

        // --- NEW MASTER DATE LOGIC ---
        function initializeDateLogic() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const checkInInput = document.getElementById('checkIn');
            const checkOutInput = document.getElementById('checkOut');

            const allEventDateInputs = document.querySelectorAll('#flightDate, #trainDate, #busDate, #activityDate, #checkIn');

            if (startDateInput.value) {
                endDateInput.min = startDateInput.value;
            }
            if (endDateInput.value) {
                startDateInput.max = endDateInput.value;
            }

            allEventDateInputs.forEach(input => {
                if (startDateInput.value) input.min = startDateInput.value;
                else input.removeAttribute('min');
                
                if (endDateInput.value) input.max = endDateInput.value;
                else input.removeAttribute('max');
            });
            
            if (checkInInput.value) {
                checkOutInput.disabled = false;
                checkOutInput.min = checkInInput.value;
                if (endDateInput.value) {
                    checkOutInput.max = endDateInput.value;
                } else {
                    checkOutInput.removeAttribute('max');
                }
                if (checkOutInput.value && new Date(checkOutInput.value) < new Date(checkInInput.value)) {
                    checkOutInput.value = '';
                }
            } else {
                checkOutInput.disabled = true;
                checkOutInput.value = '';
            }
            
            document.getElementById("nightsDisplay").innerText = calculateNights(startDateInput.value, endDateInput.value);
            saveData();
        }

        document.getElementById('startDate').addEventListener('change', initializeDateLogic);
        document.getElementById('endDate').addEventListener('change', initializeDateLogic);
        document.getElementById('checkIn').addEventListener('change', initializeDateLogic);
        // --- END OF NEW DATE LOGIC ---


        function updateKidsAges() { const kidsCount = parseInt(document.getElementById("kids").value) || 0; const container = document.getElementById("kidsAgesContainer"); container.innerHTML = ''; for (let i = 1; i <= kidsCount; i++) { const formGroup = document.createElement("div"); formGroup.className = "form-group"; formGroup.innerHTML = `<label for="kidAge${i}">Age of Kid ${i}</label><input type="number" id="kidAge${i}" placeholder="e.g., 5" min="0" max="17">`; container.appendChild(formGroup); } }
        function addPlace() { clearError(); const placeInput = document.getElementById("place"); const place = placeInput.value.trim(); if (!place) return displayError("Please enter a valid place name."); if (places.includes(place)) return displayError("This place has already been added."); places.push(place); renderPlaces(); placeInput.value = ''; saveData(); }
        function removePlace(index) { places.splice(index, 1); renderPlaces(); saveData(); if (!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary(); }
        function renderPlaces() { document.getElementById("placesList").innerHTML = places.map((p, i) => `<span style="display:inline-flex; align-items:center; gap: 8px; background: #eef1f4; padding: 5px 10px; border-radius: 6px; margin-right: 10px; margin-bottom: 10px;">${p} <button class="btn-remove" style="padding: 2px 6px; font-size:12px;" onclick="removePlace(${i})">✖</button></span>`).join(''); }
        function clearFormFields(fields) { fields.forEach(id => document.getElementById(id).value = ''); }
        
        // --- FLIGHT LOGIC ---
        function resetFlightForm() {
            currentlyEditing = null;
            clearFormFields(["airline", "departure", "arrival", "flightDate", "flightCost", "flightDescription"]);
            document.getElementById('flightActions').innerHTML = `<button class="btn-secondary" onclick="addFlight()">+ Add Flight</button>`;
        }
        function addFlight() {
            const data = { airline: document.getElementById("airline").value.trim(), departure: document.getElementById("departure").value.trim(), arrival: document.getElementById("arrival").value.trim(), flightDate: document.getElementById("flightDate").value, flightCost: parseFloat(document.getElementById("flightCost").value) || 0, flightDescription: document.getElementById("flightDescription").value.trim() };
            if (!data.airline || !data.departure || !data.arrival || !data.flightDate) { return displayError("Please fill all required flight details."); }
            flights.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetFlightForm();
        }
        function editFlight(index) {
            currentlyEditing = { type: 'flight', index };
            const flight = flights[index];
            document.getElementById("airline").value = flight.airline;
            document.getElementById("departure").value = flight.departure;
            document.getElementById("arrival").value = flight.arrival;
            document.getElementById("flightDate").value = flight.flightDate;
            document.getElementById("flightCost").value = flight.flightCost;
            document.getElementById("flightDescription").value = flight.flightDescription;
            document.getElementById('flightActions').innerHTML = `
                <button class="btn-primary" onclick="updateFlight()">Update Flight</button>
                <button class="btn-secondary" onclick="resetFlightForm()">Cancel</button>`;
            document.getElementById('airline').focus();
        }
        function updateFlight() {
            const index = currentlyEditing.index;
            const data = { airline: document.getElementById("airline").value.trim(), departure: document.getElementById("departure").value.trim(), arrival: document.getElementById("arrival").value.trim(), flightDate: document.getElementById("flightDate").value, flightCost: parseFloat(document.getElementById("flightCost").value) || 0, flightDescription: document.getElementById("flightDescription").value.trim() };
            if (!data.airline || !data.departure || !data.arrival || !data.flightDate) { return displayError("Please fill all required flight details."); }
            flights[index] = data;
            saveData();
            generateItinerary();
            resetFlightForm();
        }
        function removeFlight(index) { flights.splice(index, 1); saveData(); generateItinerary(); }
        
        // --- TRAIN LOGIC ---
        function resetTrainForm() {
            currentlyEditing = null;
            clearFormFields(["trainName", "trainDate", "trainTime", "trainDescription", "trainCost"]);
            document.getElementById('trainActions').innerHTML = `<button class="btn-secondary" onclick="addTrain()">+ Add Train</button>`;
        }
        function addTrain() {
            const data = { name: document.getElementById("trainName").value.trim(), date: document.getElementById("trainDate").value, time: document.getElementById("trainTime").value, description: document.getElementById("trainDescription").value.trim(), trainCost: parseFloat(document.getElementById("trainCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Train Name and Date."); }
            trains.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetTrainForm();
        }
        function editTrain(index) {
            currentlyEditing = { type: 'train', index };
            const train = trains[index];
            document.getElementById("trainName").value = train.name;
            document.getElementById("trainDate").value = train.date;
            document.getElementById("trainTime").value = train.time;
            document.getElementById("trainDescription").value = train.description;
            document.getElementById("trainCost").value = train.trainCost;
            document.getElementById('trainActions').innerHTML = `
                <button class="btn-primary" onclick="updateTrain()">Update Train</button>
                <button class="btn-secondary" onclick="resetTrainForm()">Cancel</button>`;
            document.getElementById('trainName').focus();
        }
        function updateTrain() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("trainName").value.trim(), date: document.getElementById("trainDate").value, time: document.getElementById("trainTime").value, description: document.getElementById("trainDescription").value.trim(), trainCost: parseFloat(document.getElementById("trainCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Train Name and Date."); }
            trains[index] = data;
            saveData();
            generateItinerary();
            resetTrainForm();
        }
        function removeTrain(index) { trains.splice(index, 1); saveData(); generateItinerary(); }

        // --- BUS LOGIC ---
        function resetBusForm() {
            currentlyEditing = null;
            clearFormFields(["busName", "busDate", "busDescription", "busCost"]);
            document.getElementById('busActions').innerHTML = `<button class="btn-secondary" onclick="addBus()">+ Add Bus</button>`;
        }
        function addBus() {
            const data = { name: document.getElementById("busName").value.trim(), date: document.getElementById("busDate").value, description: document.getElementById("busDescription").value.trim(), busCost: parseFloat(document.getElementById("busCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Bus Name and Date."); }
            buses.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetBusForm();
        }
        function editBus(index) {
            currentlyEditing = { type: 'bus', index };
            const bus = buses[index];
            document.getElementById("busName").value = bus.name;
            document.getElementById("busDate").value = bus.date;
            document.getElementById("busDescription").value = bus.description;
            document.getElementById("busCost").value = bus.busCost;
            document.getElementById('busActions').innerHTML = `
                <button class="btn-primary" onclick="updateBus()">Update Bus</button>
                <button class="btn-secondary" onclick="resetBusForm()">Cancel</button>`;
            document.getElementById('busName').focus();
        }
        function updateBus() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("busName").value.trim(), date: document.getElementById("busDate").value, description: document.getElementById("busDescription").value.trim(), busCost: parseFloat(document.getElementById("busCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Bus Name and Date."); }
            buses[index] = data;
            saveData();
            generateItinerary();
            resetBusForm();
        }
        function removeBus(index) { buses.splice(index, 1); saveData(); generateItinerary(); }
        
         // --- TRANSFER LOGIC ---
        function resetTransferForm() {
            currentlyEditing = null;
            clearFormFields(["transferName", "transferType", "transferCost"]);
            document.getElementById('transferActions').innerHTML = `<button class="btn-secondary" onclick="addTransfer()">+ Add Transfer</button>`;
        }
        function addTransfer() {
            const data = { name: document.getElementById("transferName").value.trim(), type: document.getElementById("transferType").value, cost: parseFloat(document.getElementById("transferCost").value) || 0 };
            if (!data.name || !data.type) { return displayError("Please fill Transfer Name and Type."); }
            transfers.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetTransferForm();
        }
        function editTransfer(index) {
            currentlyEditing = { type: 'transfer', index };
            const transfer = transfers[index];
            document.getElementById("transferName").value = transfer.name;
            document.getElementById("transferType").value = transfer.type;
            document.getElementById("transferCost").value = transfer.cost;
            document.getElementById('transferActions').innerHTML = `
                <button class="btn-primary" onclick="updateTransfer()">Update Transfer</button>
                <button class="btn-secondary" onclick="resetTransferForm()">Cancel</button>`;
            document.getElementById('transferName').focus();
        }
        function updateTransfer() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("transferName").value.trim(), type: document.getElementById("transferType").value, cost: parseFloat(document.getElementById("transferCost").value) || 0 };
            if (!data.name || !data.type) { return displayError("Please fill Transfer Name and Type."); }
            transfers[index] = data;
            saveData();
            generateItinerary();
            resetTransferForm();
        }
        function removeTransfer(index) { transfers.splice(index, 1); saveData(); generateItinerary(); }


        // --- HOTEL LOGIC ---
        function resetHotelForm() {
            currentlyEditing = null;
            clearFormFields(["hotelName", "hotelLocation", "roomCategory", "checkIn", "checkOut", "hotelCost"]);
            initializeDateLogic(); // Reset date states
            document.getElementById('hotelActions').innerHTML = `<button class="btn-secondary" onclick="addHotel()">+ Add Hotel</button>`;
        }
        function addHotel() {
            const data = { hotelName: document.getElementById("hotelName").value.trim(), hotelLocation: document.getElementById("hotelLocation").value.trim(), roomCategory: document.getElementById("roomCategory").value.trim(), checkIn: document.getElementById("checkIn").value, checkOut: document.getElementById("checkOut").value, hotelCost: parseFloat(document.getElementById("hotelCost").value) || 0 };
            if (!data.hotelName || !data.hotelLocation || !data.checkIn || !data.checkOut) { return displayError("Please fill all required hotel details."); }
            if (new Date(data.checkOut) < new Date(data.checkIn)) { return displayError("Check-out date must be on or after the check-in date."); }
            hotels.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetHotelForm();
        }
        function editHotel(index) {
            currentlyEditing = { type: 'hotel', index };
            const hotel = hotels[index];
            document.getElementById("hotelName").value = hotel.hotelName;
            document.getElementById("hotelLocation").value = hotel.hotelLocation;
            document.getElementById("roomCategory").value = hotel.roomCategory;
            document.getElementById("checkIn").value = hotel.checkIn;
            document.getElementById("checkOut").value = hotel.checkOut;
            document.getElementById("hotelCost").value = hotel.hotelCost;
            initializeDateLogic(); 
            document.getElementById('hotelActions').innerHTML = `
                <button class="btn-primary" onclick="updateHotel()">Update Hotel</button>
                <button class="btn-secondary" onclick="resetHotelForm()">Cancel</button>`;
            document.getElementById('hotelName').focus();
        }
        function updateHotel() {
            const index = currentlyEditing.index;
            const data = { hotelName: document.getElementById("hotelName").value.trim(), hotelLocation: document.getElementById("hotelLocation").value.trim(), roomCategory: document.getElementById("roomCategory").value.trim(), checkIn: document.getElementById("checkIn").value, checkOut: document.getElementById("checkOut").value, hotelCost: parseFloat(document.getElementById("hotelCost").value) || 0 };
            if (!data.hotelName || !data.hotelLocation || !data.checkIn || !data.checkOut) { return displayError("Please fill all required hotel details."); }
            if (new Date(data.checkOut) < new Date(data.checkIn)) { return displayError("Check-out date must be on or after the check-in date."); }
            hotels[index] = data;
            saveData();
            generateItinerary();
            resetHotelForm();
        }
        function removeHotel(index) { hotels.splice(index, 1); saveData(); generateItinerary(); }
        
        // --- ACTIVITY LOGIC ---
        function resetActivityForm() {
            currentlyEditing = null;
            clearFormFields(["activityName", "activityLocation", "activityDate", "activityCost", "activityDescription"]);
            document.getElementById('activityActions').innerHTML = `<button class="btn-secondary" onclick="addActivity()">+ Add Activity</button>`;
        }
        function addActivity() {
            const data = { activityName: document.getElementById("activityName").value.trim(), activityLocation: document.getElementById("activityLocation").value.trim(), activityDate: document.getElementById("activityDate").value, activityCost: parseFloat(document.getElementById("activityCost").value) || 0, activityDescription: document.getElementById("activityDescription").value.trim() };
            if (!data.activityName || !data.activityLocation || !data.activityDate) { return displayError("Please fill at least the Activity Name, Location, and Date."); }
            activities.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetActivityForm();
        }
        function editActivity(index) {
            currentlyEditing = { type: 'activity', index };
            const activity = activities[index];
            document.getElementById("activityName").value = activity.activityName;
            document.getElementById("activityLocation").value = activity.activityLocation;
            document.getElementById("activityDate").value = activity.activityDate;
            document.getElementById("activityCost").value = activity.activityCost;
            document.getElementById("activityDescription").value = activity.activityDescription;
            document.getElementById('activityActions').innerHTML = `
                <button class="btn-primary" onclick="updateActivity()">Update Activity</button>
                <button class="btn-secondary" onclick="resetActivityForm()">Cancel</button>`;
            document.getElementById('activityName').focus();
        }
        function updateActivity() {
            const index = currentlyEditing.index;
            const data = { activityName: document.getElementById("activityName").value.trim(), activityLocation: document.getElementById("activityLocation").value.trim(), activityDate: document.getElementById("activityDate").value, activityCost: parseFloat(document.getElementById("activityCost").value) || 0, activityDescription: document.getElementById("activityDescription").value.trim() };
            if (!data.activityName || !data.activityLocation || !data.activityDate) { return displayError("Please fill at least the Activity Name, Location, and Date."); }
            activities[index] = data;
            saveData();
            generateItinerary();
            resetActivityForm();
        }
        function removeActivity(index) { activities.splice(index, 1); saveData(); generateItinerary(); }


        function generateItinerary(shouldScroll = false) {
            clearError();
            const clientName = document.getElementById("clientName").value.trim();
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            if (!clientName || !startDate || !endDate) { if(document.getElementById('itinerary').classList.contains('hidden')) {return} else { displayError("Please fill in Traveler Name and Travel Dates.")}; return; }
            document.getElementById("itinerary").classList.remove("hidden");
            
            document.getElementById("itineraryClientName").innerText = clientName;
            document.getElementById("itineraryClientEmail").innerText = document.getElementById("clientEmail").value || 'N/A';
            document.getElementById("itineraryTravelDates").innerText = `${startDate} to ${endDate}`;
            document.getElementById("itineraryCountry").innerText = document.getElementById("country").value || 'N/A';
            document.getElementById("itineraryPlaces").innerText = places.join(", ") || "N/A";
            document.getElementById("itineraryNights").innerText = calculateNights(startDate, endDate);
            document.getElementById("itineraryTravelers").innerText = `${document.getElementById("adults").value} Adults, ${document.getElementById("kids").value} Kids`;
            
            renderTables();
            renderAutomatedDayWise(startDate, endDate);
            
            const checkedInclusions = inclusions.filter(i => i.checked).map(i => `<li>${i.text}</li>`).join('');
            const checkedExclusions = exclusions.filter(e => e.checked).map(e => `<li>${e.text}</li>`).join('');
            document.getElementById("inclusionsListHtml").innerHTML = checkedInclusions;
            document.getElementById("exclusionsListHtml").innerHTML = checkedExclusions;
            if(checkedInclusions || checkedExclusions) { document.getElementById("inc_exc_section_html").classList.remove('hidden'); } else { document.getElementById("inc_exc_section_html").classList.add('hidden'); }

            const totalFlightCost = flights.reduce((sum, f) => sum + (f.flightCost || 0), 0);
            const totalTrainCost = trains.reduce((sum, t) => sum + (t.trainCost || 0), 0);
            const totalBusCost = buses.reduce((sum, b) => sum + (b.busCost || 0), 0);
            const totalTransferCost = transfers.reduce((sum, t) => sum + (t.cost || 0), 0);
            const totalHotelCost = hotels.reduce((sum, h) => sum + (h.hotelCost || 0), 0);
            const totalActivityCost = activities.reduce((sum, a) => sum + (a.activityCost || 0), 0);
            const marginCost = parseFloat(document.getElementById("marginCost").value) || 0;

            document.getElementById("totalCost").innerText = (totalFlightCost + totalTrainCost + totalBusCost + totalTransferCost + totalHotelCost + totalActivityCost + marginCost).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            makeTablesSortable();

            if (shouldScroll) {
                document.getElementById("itinerary").scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderTables() {
            const render = (tableId, sectionId, data, columns, editFn, removeFn) => {
                const tableBody = document.getElementById(tableId).querySelector("tbody");
                const section = document.getElementById(sectionId);
                tableBody.innerHTML = '';
                if (data.length === 0) { section.style.display = 'none'; return; }
                section.style.display = 'block';
                data.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    columns.forEach(col => row.insertCell().textContent = col.render(item));
                    const actionCell = row.insertCell();
                    actionCell.className = 'actions-cell';
                    actionCell.innerHTML = `
                        <button class="btn-edit" onclick="${editFn}(${index})">Edit</button>
                        <button class="btn-remove" onclick="${removeFn}(${index})">Remove</button>`;
                });
            };
            const formatCurrency = (num) => `₹${(num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            render('flightsTable', 'flights_section', flights, [{ render: i => i.airline }, { render: i => i.departure }, { render: i => i.arrival }, { render: i => i.flightDate }, { render: i => formatCurrency(i.flightCost) }], 'editFlight', 'removeFlight');
            render('trainsTable', 'trains_section', trains, [{ render: i => i.name }, { render: i => i.date }, { render: i => i.time || 'N/A' }, { render: i => i.description }, { render: i => formatCurrency(i.trainCost) }], 'editTrain', 'removeTrain');
            render('busesTable', 'buses_section', buses, [{ render: i => i.name }, { render: i => i.date }, { render: i => i.description }, { render: i => formatCurrency(i.busCost) }], 'editBus', 'removeBus');
            render('transfersTable', 'transfers_section', transfers, [{ render: i => i.name }, { render: i => i.type }, { render: i => formatCurrency(i.cost) }], 'editTransfer', 'removeTransfer');
            render('hotelsTable', 'hotels_section', hotels, [{ render: i => i.hotelName }, { render: i => i.hotelLocation }, { render: i => i.roomCategory }, { render: i => i.checkIn }, { render: i => i.checkOut }, { render: i => formatCurrency(i.hotelCost) }], 'editHotel', 'removeHotel');
            render('activitiesTable', 'activities_section', activities, [{ render: i => i.activityName }, { render: i => i.activityDescription }, { render: i => i.activityDate }, { render: i => formatCurrency(i.activityCost) }], 'editActivity', 'removeActivity');
        }

        function makeTablesSortable() {
            const sortableOptions = (dataArray) => ({
                animation: 150,
                onEnd: (evt) => {
                    const [item] = dataArray.splice(evt.oldIndex, 1);
                    dataArray.splice(evt.newIndex, 0, item);
                    saveData();
                    generateItinerary();
                }
            });
            if (typeof Sortable === 'undefined') return;
            new Sortable(document.getElementById('flightsTable').querySelector('tbody'), sortableOptions(flights));
            new Sortable(document.getElementById('trainsTable').querySelector('tbody'), sortableOptions(trains));
            new Sortable(document.getElementById('busesTable').querySelector('tbody'), sortableOptions(buses));
            new Sortable(document.getElementById('transfersTable').querySelector('tbody'), sortableOptions(transfers));
            new Sortable(document.getElementById('hotelsTable').querySelector('tbody'), sortableOptions(hotels));
            new Sortable(document.getElementById('activitiesTable').querySelector('tbody'), sortableOptions(activities));
        }


        function renderAutomatedDayWise(startDateStr, endDateStr) {
            const container = document.getElementById("dayWiseItinerary");
            const section = document.getElementById("daywise_section");
            container.innerHTML = '';
            const totalNights = calculateNights(startDateStr, endDateStr);
            if (totalNights < 0) { section.style.display = 'none'; return; }
            const totalDays = totalNights + 1;
            let hasContent = false;
            const startDate = new Date(startDateStr);
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setUTCDate(currentDate.getUTCDate() + i);
                const dateString = currentDate.toISOString().split('T')[0];
                
                let eventsHtml = '';

                hotels.filter(h => h.checkOut === dateString).forEach(h => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏨 Check-out: ${h.hotelName}</span><span class="item-location">${h.hotelLocation}</span></div></li>`; });
                flights.filter(f => f.flightDate === dateString).forEach(f => { eventsHtml += `<li><div class="item-details"><span class="item-title">✈️ Flight: ${f.airline} to ${f.arrival}</span><span class="item-location">${f.flightDescription || 'Details unavailable'}</span></div></li>`; });
                trains.filter(t => t.date === dateString).forEach(t => { eventsHtml += `<li><div class="item-details"><span class="item-title">🚆 Train: ${t.name}</span><span class="item-location">${t.description || 'Details unavailable'}</span></div></li>`; });
                buses.filter(b => b.date === dateString).forEach(b => { eventsHtml += `<li><div class="item-details"><span class="item-title">🚌 Bus: ${b.name}</span><span class="item-location">${b.description || 'Details unavailable'}</span></div></li>`; });
                hotels.filter(h => h.checkIn === dateString).forEach(h => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏨 Check-in: ${h.hotelName}</span><span class="item-location">${h.hotelLocation}</span></div></li>`; });
                activities.filter(a => a.activityDate === dateString).forEach(a => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏞️ Activity: ${a.activityName}</span><span class="item-location">${a.activityLocation}</span></div></li>`; });

                if (eventsHtml) {
                    hasContent = true;
                    const dayHeader = `<h4>${currentDate.toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'long', month: 'long', day: 'numeric' })}</h4>`;
                    container.innerHTML += `<div class="day-entry" data-day="${i + 1}">${dayHeader}<ul class="day-item-list">${eventsHtml}</ul></div>`;
                }
            }
            section.style.display = hasContent ? 'block' : 'none';
        }

        function formatDateToDDMMYYYY(dateStr) {
            if (!dateStr || !dateStr.includes('-')) return dateStr;
            const [year, month, day] = dateStr.split('-');
            return `${day}-${month}-${year}`;
        }
        
        function downloadPDF(pdfType) {
            clearError();
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert("PDF libraries not loaded. Please check your internet connection.");
                return;
            }
            if (!document.getElementById('clientName').value) {
                displayError("Cannot generate a PDF without a client name.");
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                
                const brandColor = '#05C3DE';
                const textColor = '#1d1d1f';
                const lightTextColor = '#515154';
                const borderColor = '#dee2e6';
                const backgroundColor = '#f5f5f7';
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 40;
                const usableWidth = pageWidth - (margin * 2);

                const sanitizeText = (text) => {
                    if (typeof text !== 'string' || !text) return '';
                    return text
                        .replace(/[`‘’'“”"]/g, "")      
                        .replace(/\s\s+/g, ' ')         
                        .replace(/[^\x20-\x7E]/g, '')   
                        .trim();
                };
                
                const formatCurrencyForPDF = (num) => `INR ${ (num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                doc.setFont('Helvetica');
                let yPos = 0;

                // --- Header ---
                doc.setFillColor(brandColor);
                doc.rect(0, 0, pageWidth, 112, 'F');
                doc.setFontSize(22).setFont('Helvetica', 'bold').setTextColor('#FFFFFF').text('Travelverse.in', margin, 40);
                doc.setFontSize(8).setFont('Helvetica', 'normal').setTextColor('#FFFFFF');
                doc.text('We Work, DLF Forum, CyberCity, Phase 3, Gurugram, Haryana 122002', margin, 58);
                doc.text('Email : explore@travelverse.in', margin, 70);
                doc.text('Phone : +919996968070', margin, 82);
                doc.text('Awarded for excellence by Govt. of India (Ministry of Statistical Organisation by Shree PR Meshram)', margin, 94);
                doc.setFontSize(10).setTextColor('#FFFFFF').text('www.travelverse.in', pageWidth - margin, 40, { align: 'right' });

                yPos = 140;
                
                const addSectionHeader = (title, underline = true) => {
                    checkPageBreak(60);
                    yPos += 35; 
                    doc.setFontSize(14).setFont('Helvetica', 'bold').setTextColor(textColor).text(title, margin, yPos);
                    if (underline) {
                        const textWidth = doc.getTextWidth(title);
                        doc.setDrawColor(borderColor); 
                        doc.setLineWidth(1.5);
                        doc.line(margin, yPos + 4, margin + textWidth, yPos + 4);
                    }
                    yPos += 25; 
                };

                const addBulletedList = (items) => {
                    doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    items.forEach(item => {
                        const itemLines = doc.splitTextToSize(`•  ${sanitizeText(item)}`, usableWidth - 10);
                        checkPageBreak((itemLines.length * 11) + 3);
                        doc.text(itemLines, margin + 10, yPos);
                        yPos += (itemLines.length * 11) + 3;
                    });
                };
                
                const checkPageBreak = (requiredHeight) => {
                    if (yPos + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };
                
                function drawBarcode(doc, x, y, width, height) {
                    const numBars = Math.floor(width / 1.5);
                    let currentX = x;
                    doc.setFillColor(textColor);
                    for (let i = 0; i < numBars; i++) {
                        const barWidth = Math.random() * 1.2 + 0.4;
                        if (currentX + barWidth > x + width) break;
                        doc.rect(currentX, y, barWidth, height, 'F');
                        currentX += barWidth + (Math.random() * 0.8 + 0.4);
                    }
                }

                function drawPlaneIcon(doc, x, y, size, color) {
                    doc.setDrawColor(color);
                    doc.setLineWidth(1.5);
                    doc.line(x, y, x + size, y);
                    doc.line(x + size * 0.4, y, x + size * 0.6, y - size * 0.4);
                    doc.line(x + size * 0.4, y, x + size * 0.6, y + size * 0.4);
                    doc.line(x + size * 0.8, y, x + size * 0.9, y - size * 0.25);
                }

                const clientName = sanitizeText(document.getElementById('clientName').value);
                const countryName = sanitizeText(document.getElementById('country').value) || 'Your Destination';
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const nights = calculateNights(startDate, endDate);
                const travelers = `${document.getElementById("adults").value} Adults, ${document.getElementById("kids").value} Kids`;
                const placesJoined = sanitizeText(places.join(", ")) || 'N/A';

                const cardX = margin;
                const cardY = yPos;
                const cardWidth = usableWidth;
                const cardHeight = 175;
                const cornerRadius = 20;
                const stubWidth = 160;
                const mainWidth = cardWidth - stubWidth;
                const separatorX = cardX + mainWidth;

                doc.setDrawColor(borderColor);
                doc.setFillColor('#FFFFFF');
                doc.roundedRect(cardX, cardY, cardWidth, cardHeight, cornerRadius, cornerRadius, 'FD');

                let contentX = cardX + 25;
                let contentY = cardY + 30;
                const col2X = contentX + 180; 

                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(brandColor).text("YOUR TRIP OVERVIEW", contentX, contentY);
                doc.setFontSize(22).setFont('Helvetica', 'bold').setTextColor(textColor).text(countryName, contentX, contentY + 25);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("CLIENT", contentX, contentY + 55);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(clientName, contentX, contentY + 70);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("DATES", col2X, contentY + 55);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(`${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)}`, col2X, contentY + 70);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("PLACES TO VISIT", contentX, contentY + 95);
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(textColor);
                const placesLines = doc.splitTextToSize(placesJoined, col2X - contentX - 15);
                doc.text(placesLines, contentX, contentY + 108);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("TRAVELERS", col2X, contentY + 95);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(travelers, col2X, contentY + 108);
                doc.setLineDashPattern([2, 2], 0);
                doc.setDrawColor(borderColor).line(separatorX, cardY + 15, separatorX, cardY + cardHeight - 15);
                doc.setLineDashPattern([], 0);
                
                const stubCenterX = separatorX + stubWidth / 2;
                drawPlaneIcon(doc, stubCenterX - 15, cardY + 25, 30, brandColor);
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(textColor).text("TRIP QUOTE", stubCenterX, cardY + 55, { align: 'center' });
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("Prepared for:", stubCenterX, cardY + 75, { align: 'center' });
                doc.setFontSize(11).setFont('Helvetica', 'bold').setTextColor(textColor).text(clientName, stubCenterX, cardY + 90, { align: 'center' });
                const barcodeY = cardY + 110;
                const barcodeWidth = stubWidth - 30;
                const barcodeHeight = 35;
                drawBarcode(doc, stubCenterX - (barcodeWidth / 2), barcodeY, barcodeWidth, barcodeHeight);
                doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(lightTextColor).text("0123456789-TRVL-9876543210", stubCenterX, barcodeY + barcodeHeight + 7, { align: 'center'});
                yPos = cardY + cardHeight;
                
                const tableConfig = {
                    theme: 'plain',
                    styles: {
                        font: 'Helvetica',
                        fontSize: 9,
                        cellPadding: 8,
                        textColor: textColor,
                        valign: 'middle',
                    },
                    headStyles: {
                        fillColor: brandColor,
                        textColor: '#ffffff',
                        fontStyle: 'bold',
                        fontSize: 10,
                    },
                    alternateRowStyles: {
                        fillColor: backgroundColor
                    },
                    startY: yPos,
                    didDrawPage: (data) => {
                        yPos = data.cursor.y;
                    },
                    didDrawTable: (data) => {
                        const { table } = data;
                        const { x, y, width, height } = table;
                        const headerHeight = table.head[0].height;
                        const cornerRadius = 6;

                        // Draw the rounded border around the entire table
                        doc.setLineWidth(1);
                        doc.setDrawColor(borderColor);
                        doc.roundedRect(x, y, width, height, cornerRadius, cornerRadius, 'S');
                        
                        // Clip the top part of the rectangle to create rounded top corners for the header
                        doc.save();
                        doc.beginPath();
                        doc.moveTo(x + cornerRadius, y);
                        doc.lineTo(x + width - cornerRadius, y);
                        doc.quadraticCurveTo(x + width, y, x + width, y + cornerRadius);
                        doc.lineTo(x + width, y + headerHeight);
                        doc.lineTo(x, y + headerHeight);
                        doc.lineTo(x, y + cornerRadius);
                        doc.quadraticCurveTo(x, y, x + cornerRadius, y);
                        doc.closePath();
                        doc.clip();
                        
                        doc.setFillColor(brandColor);
                        doc.rect(x, y, width, headerHeight, 'F');
                        
                        doc.restore();

                        doc.setTextColor('#ffffff');
                        doc.setFont('Helvetica', 'bold');
                        doc.setFontSize(10);
                        table.head[0].cells.forEach(cell => {
                            const textY = cell.y + cell.height / 2;
                            doc.text(
                                cell.text,
                                cell.x + cell.padding('left'),
                                textY,
                                {
                                    baseline: 'middle',
                                    align: cell.styles.halign
                                }
                            );
                        });
                    }
                };
                const isClientPDF = (pdfType === 'client');

                if (flights.length > 0) {
                    addSectionHeader('Flights'); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Airline', 'Route', 'Date', 'Description']] : [['Airline', 'Route', 'Date', 'Description', 'Cost']], body: flights.map(f => { const row = [sanitizeText(f.airline), `${sanitizeText(f.departure)} to ${sanitizeText(f.arrival)}`, formatDateToDDMMYYYY(f.flightDate), sanitizeText(f.flightDescription)]; if (!isClientPDF) row.push(formatCurrencyForPDF(f.flightCost)); return row; }), columnStyles: { 0: { cellWidth: 100 }, 1: { cellWidth: 100 }, 2: { cellWidth: 70 }, 3: { overflow: 'linebreak' }, 4: !isClientPDF ? {halign: 'right'} : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                 if (trains.length > 0) {
                    addSectionHeader('Train Details'); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Operator', 'Date', 'Time', 'Description']] : [['Operator', 'Date', 'Time', 'Description', 'Cost']], body: trains.map(t => { const row = [sanitizeText(t.name), formatDateToDDMMYYYY(t.date), t.time || '', sanitizeText(t.description)]; if (!isClientPDF) row.push(formatCurrencyForPDF(t.trainCost)); return row; }), columnStyles: { 1: { cellWidth: 70 }, 3: { overflow: 'linebreak' }, 4: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (buses.length > 0) {
                    addSectionHeader('Bus Details'); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Operator', 'Date', 'Description']] : [['Operator', 'Date', 'Description', 'Cost']], body: buses.map(b => { const row = [sanitizeText(b.name), formatDateToDDMMYYYY(b.date), sanitizeText(b.description)]; if (!isClientPDF) row.push(formatCurrencyForPDF(b.busCost)); return row; }), columnStyles: { 1: { cellWidth: 70 }, 2: { overflow: 'linebreak' }, 3: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (transfers.length > 0) {
                    addSectionHeader('Transfers'); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Name', 'Type']] : [['Name', 'Type', 'Cost']], body: transfers.map(t => { const row = [sanitizeText(t.name), sanitizeText(t.type)]; if (!isClientPDF) row.push(formatCurrencyForPDF(t.cost)); return row; }), columnStyles: { 2: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (hotels.length > 0) {
                    addSectionHeader('Accommodations'); tableConfig.startY = yPos;
                    const hotelColumnStyles = isClientPDF 
                        ? { 3: { cellWidth: 75 }, 4: { cellWidth: 75 }, 5: { cellWidth: 50, halign: 'center' } } 
                        : { 3: { cellWidth: 65 }, 4: { cellWidth: 65 }, 5: { cellWidth: 50, halign: 'center' }, 6: { halign: 'right' } };
                    
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Hotel', 'Location', 'Room Category', 'Check-in', 'Check-out', 'Nights']] : [['Hotel', 'Location', 'Room Category', 'Check-in', 'Check-out', 'Nights', 'Total Cost']], 
                    body: hotels.map(h => { const hotelNights = calculateNights(h.checkIn, h.checkOut); const row = [sanitizeText(h.hotelName), sanitizeText(h.hotelLocation), sanitizeText(h.roomCategory), formatDateToDDMMYYYY(h.checkIn), formatDateToDDMMYYYY(h.checkOut), hotelNights]; if (!isClientPDF) row.push(formatCurrencyForPDF(h.hotelCost)); return row; }), 
                    columnStyles: hotelColumnStyles
                    }); 
                    yPos = doc.autoTable.previous.finalY;
                }
                if (activities.length > 0) {
                    addSectionHeader('Sightseeings'); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Activity', 'Location', 'Date', 'Description']] : [['Activity', 'Location', 'Date', 'Description', 'Cost']], body: activities.map(a => { const row = [sanitizeText(a.activityName), sanitizeText(a.activityLocation), formatDateToDDMMYYYY(a.activityDate), sanitizeText(a.activityDescription) || '']; if (!isClientPDF) row.push(formatCurrencyForPDF(a.activityCost)); return row; }), 
                    columnStyles: { 
                        0: { cellWidth: 200, overflow: 'linebreak' }, 
                        1: { cellWidth: 80 }, 
                        2: { cellWidth: 70 }, 
                        3: { overflow: 'linebreak' }, 
                        4: !isClientPDF ? { halign: 'right' } : {} 
                    } 
                }); yPos = doc.autoTable.previous.finalY;
                }
                
                const dayWiseData = [];
                if (nights >= 0 && startDate) { 
                    const start = new Date(startDate);
                    for (let i = 0; i <= nights; i++) {
                        const d = new Date(start); d.setUTCDate(d.getUTCDate() + i); const dateStr = d.toISOString().split('T')[0];
                        let events = [];
                        hotels.filter(h => h.checkOut === dateStr).forEach(h => events.push(`Check-out: ${sanitizeText(h.hotelName)}, ${sanitizeText(h.hotelLocation)}`));
                        flights.filter(f => f.flightDate === dateStr).forEach(f => events.push(`Flight: ${sanitizeText(f.airline)} (${sanitizeText(f.departure)} to ${sanitizeText(f.arrival)})`));
                        trains.filter(t => t.date === dateStr).forEach(t => events.push(`Train: ${sanitizeText(t.name)} - ${sanitizeText(t.description)}`));
                        buses.filter(b => b.date === dateStr).forEach(b => events.push(`Bus: ${sanitizeText(b.name)} - ${sanitizeText(b.description)}`));
                        hotels.filter(h => h.checkIn === dateStr).forEach(h => events.push(`Check-in: ${sanitizeText(h.hotelName)}, ${sanitizeText(h.hotelLocation)}`));
                        activities.filter(a => a.activityDate === dateStr).forEach(a => events.push(`Activity: ${sanitizeText(a.activityName)} (${sanitizeText(a.activityLocation)})`));
                        
                        if (events.length > 0) {
                            dayWiseData.push({
                                day: i + 1,
                                date: d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }),
                                events: events
                            });
                        }
                    }
                }
                
                if (dayWiseData.length > 0) {
                    addSectionHeader('Day-wise Itinerary');
                    yPos += 15;

                    const timelineX = margin + 10;
                    const contentX = timelineX + 25;
                    const contentWidth = usableWidth - (contentX - margin);
                    
                    const dayElementPositions = [];

                    dayWiseData.forEach(dayData => {
                        let requiredHeight = 0;
                        const headerHeight = 25;
                        let eventsHeight = 0;
                        dayData.events.forEach(event => {
                            const lines = doc.splitTextToSize(`• ${event}`, contentWidth - 5);
                            eventsHeight += (lines.length * 10) + 8;
                        });
                        requiredHeight = headerHeight + eventsHeight + 20;

                        checkPageBreak(requiredHeight);
                        dayElementPositions.push({ y: yPos, page: doc.internal.getCurrentPageInfo().pageNumber, data: dayData });
                        
                        let currentContentY = yPos;
                        doc.setFontSize(11).setFont('Helvetica', 'bold').setTextColor(textColor).text(`Day ${dayData.day}: ${dayData.date}`, contentX, currentContentY);
                        currentContentY += 20;

                        doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                        dayData.events.forEach(event => {
                            const eventLines = doc.splitTextToSize(`• ${event}`, contentWidth - 5);
                            doc.text(eventLines, contentX, currentContentY);
                            currentContentY += (eventLines.length * 10) + 8;
                        });
                        yPos = currentContentY + 15;
                    });
                    
                    const totalPages = doc.internal.getNumberOfPages();
                    for(let page = 1; page <= totalPages; page++) {
                        doc.setPage(page);
                        const elementsOnPage = dayElementPositions.filter(p => p.page === page);
                        if(elementsOnPage.length > 0) {
                            const firstElementY = elementsOnPage[0].y;
                            const lastElementY = elementsOnPage[elementsOnPage.length - 1].y;
                            doc.setDrawColor(borderColor).setLineWidth(1.5).line(timelineX, firstElementY, timelineX, lastElementY);

                            elementsOnPage.forEach(pos => {
                                doc.setFillColor('#FFFFFF').circle(timelineX, pos.y, 11, 'F');
                                doc.setFillColor(brandColor).circle(timelineX, pos.y, 10, 'F');
                                doc.setFontSize(9).setFont('Helvetica', 'bold').setTextColor('#FFFFFF').text(String(pos.data.day), timelineX, pos.y + 3, { align: 'center' });
                            });
                        }
                    }
                    doc.setPage(totalPages);
                }
                
                const addIncExcList = (title, items) => { const checkedItems = items.filter(item => item.checked).map(item => sanitizeText(item.text)); if (checkedItems.length === 0) return; addSectionHeader(title); addBulletedList(checkedItems); };
                addIncExcList('Inclusions', inclusions); addIncExcList('Exclusions', exclusions);
                
                const totalFlightCost = flights.reduce((s, f) => s + (f.flightCost || 0), 0);
                const totalTrainCost = trains.reduce((s, t) => s + (t.trainCost || 0), 0);
                const totalBusCost = buses.reduce((s, b) => s + (b.busCost || 0), 0);
                const totalTransferCost = transfers.reduce((s, t) => s + (t.cost || 0), 0);
                const totalHotelCost = hotels.reduce((s, h) => s + (h.hotelCost || 0), 0);
                const totalActivityCost = activities.reduce((s, a) => s + (a.activityCost || 0), 0);
                const marginCost = parseFloat(document.getElementById("marginCost").value) || 0;
                const totalCost = totalFlightCost + totalTrainCost + totalBusCost + totalTransferCost + totalHotelCost + totalActivityCost + marginCost;

                checkPageBreak(isClientPDF ? 80 : 120);
                yPos += 30; doc.setDrawColor(borderColor).line(margin, yPos, pageWidth - margin, yPos); yPos += 10;
                
                if (!isClientPDF) {
                    const subtotal = totalCost - marginCost;
                    doc.setFontSize(12).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    doc.text('Subtotal', margin, yPos + 15);
                    doc.text(formatCurrencyForPDF(subtotal), pageWidth - margin, yPos + 15, { align: 'right' });
                    yPos += 20;

                    doc.text('Margin', margin, yPos + 15);
                    doc.text(formatCurrencyForPDF(marginCost), pageWidth - margin, yPos + 15, { align: 'right' });
                    yPos += 20;
                }

                doc.setFontSize(16).setFont('Helvetica', 'bold').setTextColor(textColor);
                doc.text('Total Estimated Cost', margin, yPos + 15);
                doc.text(formatCurrencyForPDF(totalCost), pageWidth - margin, yPos + 15, { align: 'right' });
                yPos += 25; doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 10;

                const aboutText = "At Travelverse, we believe travel should be extraordinary. Born from a passion for exploring, we specialize in crafting unique, tailor-made journeys that match your personal style. We handle all the details, from handpicking the best local partners to providing seamless support, so you can focus on creating unforgettable memories. With Travelverse, you get more than a trip; you get a perfectly organized, stress-free adventure designed just for you.";
                addSectionHeader('About Travelverse.in');
                const aboutLines = doc.splitTextToSize(aboutText, usableWidth);
                checkPageBreak(aboutLines.length * 12);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                doc.text(aboutText, margin, yPos, { maxWidth: usableWidth, align: 'justify' });
                yPos += (aboutLines.length * 11) + 10;

                addSectionHeader('Terms & Conditions');
                const terms = [
                    "This document is a quotation; no bookings have been made. All services are subject to availability at the time of booking.",
                    "To confirm the booking, a deposit of 50% of the total tour price is required.",
                    "All prices are quoted in INR and are subject to change without notice due to currency fluctuations, new government taxes, or other factors beyond our control.",
                    "We act as agents for hotels, airlines, and transport operators, and are not liable for any loss, injury, or damage sustained by the traveler directly or indirectly.",
                    "Please ensure you possess a valid passport and any required visas for the duration of your trip. Visa assistance is an optional service."
                ];
                addBulletedList(terms);
                
                addSectionHeader('Download Our On-Trip App');
                const appText = "For live updates, offline access to your documents, and direct communication with our team during your trip, download our dedicated mobile app.";
                const appTextLines = doc.splitTextToSize(appText, usableWidth);
                checkPageBreak((appTextLines.length * 12) + 80);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                doc.text(appText, margin, yPos, { maxWidth: usableWidth, align: 'justify' });
                yPos += (appTextLines.length * 11) + 25;

                const appStoreLink = "https://apps.apple.com/cn/app/travelverse-in/id6739727152";
                const playStoreLink = "https://play.google.com/store/apps/details?id=com.travelverse.travelverse_mobile_app&hl=en_IN";
                
                const buttonWidth = (usableWidth / 2) - 10;
                const buttonHeight = 40;
                const buttonRadius = 12;
                const buttonY = yPos;

                const appleButtonX = margin;
                doc.setDrawColor(borderColor);
                doc.setFillColor('#f0f0f2');
                doc.roundedRect(appleButtonX, buttonY, buttonWidth, buttonHeight, buttonRadius, buttonRadius, 'FD');
                doc.link(appleButtonX, buttonY, buttonWidth, buttonHeight, { url: appStoreLink });
                const appleIconX = appleButtonX + 22;
                const appleIconY = buttonY + (buttonHeight / 2);
                doc.setDrawColor(textColor);
                doc.setLineWidth(2.5);
                doc.line(appleIconX - 6, appleIconY + 8, appleIconX, appleIconY - 8);
                doc.line(appleIconX, appleIconY - 8, appleIconX + 6, appleIconY + 8);
                doc.setLineWidth(2);
                doc.line(appleIconX - 3.5, appleIconY + 1, appleIconX + 3.5, appleIconY + 1);
                const appleTextX = appleButtonX + 45;
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(9).setTextColor(lightTextColor).text('Download on the', appleTextX, buttonY + 18);
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(12).setTextColor(textColor).text('App Store', appleTextX, buttonY + 32);

                const googleButtonX = margin + buttonWidth + 20;
                doc.setDrawColor(borderColor);
                doc.setFillColor('#f0f0f2');
                doc.roundedRect(googleButtonX, buttonY, buttonWidth, buttonHeight, buttonRadius, buttonRadius, 'FD');
                doc.link(googleButtonX, buttonY, buttonWidth, buttonHeight, { url: playStoreLink });
                const playIconX = googleButtonX + 22;
                const playIconY = buttonY + (buttonHeight / 2);
                doc.setFillColor(textColor);
                doc.triangle(playIconX - 5, playIconY - 7, playIconX - 5, playIconY + 7, playIconX + 5, playIconY, 'F');
                const googleTextX = googleButtonX + 45;
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(9).setTextColor(lightTextColor).text('GET IT ON', googleTextX, buttonY + 18);
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(12).setTextColor(textColor).text('Google Play', googleTextX, buttonY + 32);
                
                yPos = buttonY + buttonHeight + 10;
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });
                }

                doc.setPage(pageCount);
                const footerHeight = 60;
                if (pageHeight - yPos < footerHeight + margin) {
                   doc.addPage();
                   const newPageCount = doc.internal.getNumberOfPages();
                   for (let i = 1; i <= newPageCount; i++) { doc.setPage(i); doc.text(`Page ${i} of ${newPageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });}
                   doc.setPage(newPageCount);
                }
                doc.setFillColor(brandColor);
                doc.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
                const footerLine1 = `Crafted by Travelverse for ${clientName}.`;
                const footerLine2 = `Where every journey is designed around your vibe.`;
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor('#FFFFFF');
                doc.text(footerLine1, pageWidth / 2, pageHeight - footerHeight + 28, { align: 'center' });
                doc.setFontSize(9).setFont('Helvetica', 'normal');
                doc.text(footerLine2, pageWidth / 2, pageHeight - footerHeight + 45, { align: 'center' });
                
                const fileName = `Itinerary_${isClientPDF ? 'Client' : 'Business'}_${clientName.replace(/\s/g, '_')}_${formatDateToDDMMYYYY(startDate)}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error("An unexpected error occurred during PDF generation:", error);
                alert("An unexpected error occurred while creating the PDF. Check the console for details.");
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>